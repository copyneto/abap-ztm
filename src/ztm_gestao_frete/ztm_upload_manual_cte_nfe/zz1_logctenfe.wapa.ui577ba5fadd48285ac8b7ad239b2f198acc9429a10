sap.ui.define(["sap/m/PDFViewer","sap/ui/core/util/File"],                                                                                                                                                                                                     
    function (PDFViewer, File) {                                                                                                                                                                                                                               
        "use strict";                                                                                                                                                                                                                                          
        return {                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
            onAfterRendering: function (oEvent) {                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onActionUploadFile: function (oEvent) {                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                let oView = this.getView();                                                                                                                                                                                                                    
                let oDialog = sap.ui.core.Fragment.load({                                                                                                                                                                                                      
                    id: oView.getId(),                                                                                                                                                                                                                         
                    multiple: true,                                                                                                                                                                                                                            
                    name: "br.com.trescoracoes.recebmanualctenfe.ext.view.Attachment",                                                                                                                                                                         
                    controller: this                                                                                                                                                                                                                           
                }).then(function (oDialog) {                                                                                                                                                                                                                   
                    oView.addDependent(oDialog);                                                                                                                                                                                                               
                    return oDialog;                                                                                                                                                                                                                            
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                oDialog.then(function (oDialog) {                                                                                                                                                                                                              
                    oDialog.getContent()[0].getList().setMode("SingleSelect");                                                                                                                                                                                 
                    //oDialog.getContent()[0].getList().setMultiple(true);                                                                                                                                                                                     
                    oDialog.open();                                                                                                                                                                                                                            
                });                                                                                                                                                                                                                                            
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onClose: function (oEvent) {                                                                                                                                                                                                                       
                this.byId("attachmentDialog").close();                                                                                                                                                                                                         
                this.byId("attachmentDialog").destroy();                                                                                                                                                                                                       
                this.getView().removeAllDependents();                                                                                                                                                                                                          
                this.templateBaseExtension.getExtensionAPI().refreshTable();                                                                                                                                                                                   
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onUploadCompleted: function (oEvent) {                                                                                                                                                                                                             
                oEvent.getSource().removeAllIncompleteItems();                                                                                                                                                                                                 
                oEvent.getSource().getBinding("items").refresh();                                                                                                                                                                                              
                this.templateBaseExtension.getExtensionAPI().refreshTable();                                                                                                                                                                                   
                if (oEvent.getSource().getItems().length === 0)                                                                                                                                                                                                
                    this.onClose();                                                                                                                                                                                                                            
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onFileTypeMismatch: function (oEvent) {                                                                                                                                                                                                            
                sap.m.MessageBox.error('Extesão do arquivo não suportado');                                                                                                                                                                                    
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onSelectAllAttachments: function (oEvent) {                                                                                                                                                                                                        
                var aUploadedItems = this.byId("UploadSet").getItems(),                                                                                                                                                                                        
                    bSelected = oEvent.getSource().getSelected();                                                                                                                                                                                              
                /*        if (bSelected) { //if CheckBox is selected */                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                aUploadedItems.forEach(oItem => oItem.getListItem().setSelected(bSelected));                                                                                                                                                                   
                this.byId('download').setEnabled(bSelected);                                                                                                                                                                                                   
                this.byId('remove').setEnabled(bSelected);                                                                                                                                                                                                     
                /*                 } else {                                                                                                                                                                                                                    
                                  aUploadedItems.forEach(oItem => oItem.getListItem().setSelected(false));                                                                                                                                                     
                                  this.byId('remove').setEnabled(false);                                                                                                                                                                                       
                                  this.byId('download').setEnabled(false);                                                                                                                                                                                     
                                } *//*  */                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onSelectionChangeAttachment: function () {                                                                                                                                                                                                         
                if (this.byId("UploadSet").getList().getSelectedItems().length > 0) { //if user selects 1 or more uploaded item                                                                                                                                
                    this.byId("remove").setEnabled(true);                                                                                                                                                                                                      
                    this.byId("download").setEnabled(true);                                                                                                                                                                                                    
                } else {                                                                                                                                                                                                                                       
                    this.byId("remove").setEnabled(false);                                                                                                                                                                                                     
                    this.byId("download").setEnabled(false);                                                                                                                                                                                                   
                }                                                                                                                                                                                                                                              
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onAfterItemAdded: function (oEvent) {                                                                                                                                                                                                              
                if (oEvent.getSource().getList().getSelectedItems().length > 0)                                                                                                                                                                                
                    this.byId("remove").setEnabled(true);                                                                                                                                                                                                      
                else                                                                                                                                                                                                                                           
                    this.byId("remove").setEnabled(true);                                                                                                                                                                                                      
                oEvent.getParameter("item").setVisibleEdit(false);                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                //Habilita botão                                                                                                                                                                                                                               
                this.byId("btnOk").setEnabled(true);                                                                                                                                                                                                           
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onRemove(oEvent) {                                                                                                                                                                                                                                 
                sap.m.MessageBox.confirm(this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("deleteMsg"),                                                                                                                                   
                    {                                                                                                                                                                                                                                          
                        icon: 'sap-icon://alert',                                                                                                                                                                                                              
                        title: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("deleteTitle"),                                                                                                                                           
                        onClose: function (sAction) {                                                                                                                                                                                                          
                            switch (sAction) {                                                                                                                                                                                                                 
                                case "OK":                                                                                                                                                                                                                     
                                    let oControl = this.byId("UploadSet");                                                                                                                                                                                     
                                    oControl.setBusy(true);                                                                                                                                                                                                    
                                    oControl.getItems().forEach(oItem => {                                                                                                                                                                                     
                                        if (oItem.getListItem().getSelected()) {                                                                                                                                                                               
                                            let sGuid = oItem.getBindingContext().getObject().Guid;                                                                                                                                                            
                                            this.getView().getModel("fileService").remove("/documentSet(Guid=guid'" + sGuid + "')",                                                                                                                            
                                                {                                                                                                                                                                                                              
                                                    success: function () {                                                                                                                                                                                     
                                                        oControl.removeItem(oItem); //remove from displayed list                                                                                                                                               
                                                        oControl.getBinding("items").refresh();                                                                                                                                                                
                                                    },                                                                                                                                                                                                         
                                                    error: function (oError) {                                                                                                                                                                                 
                                                    }                                                                                                                                                                                                          
                                                });                                                                                                                                                                                                            
                                        }                                                                                                                                                                                                                      
                                    });                                                                                                                                                                                                                        
                                    oControl.setBusy(false);                                                                                                                                                                                                   
                                    break;                                                                                                                                                                                                                     
                                default:                                                                                                                                                                                                                       
                                    break;                                                                                                                                                                                                                     
                            }                                                                                                                                                                                                                                  
                        }.bind(this)                                                                                                                                                                                                                           
                    });                                                                                                                                                                                                                                        
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onDownload(oEvent) {                                                                                                                                                                                                                               
                let oControl = this.byId("UploadSet");                                                                                                                                                                                                         
                oControl.setBusy(true);                                                                                                                                                                                                                        
                let sServiceUrl = window.location.origin + this.getView().getModel("fileService").sServiceUrl;                                                                                                                                                 
                oControl.getItems().forEach(oItem => {                                                                                                                                                                                                         
                    if (oItem.getListItem().getSelected()) {                                                                                                                                                                                                   
                        let sGuid = oItem.getBindingContext().getObject().Guid;                                                                                                                                                                                
                        sap.m.URLHelper.redirect(sServiceUrl + "/documentSet(Guid=guid'" + sGuid + "')/$value", true);                                                                                                                                         
                    }                                                                                                                                                                                                                                          
                });                                                                                                                                                                                                                                            
                oControl.setBusy(false);                                                                                                                                                                                                                       
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            getDate(dTimestamp) {                                                                                                                                                                                                                              
                return new Date(dTimestamp).toLocaleString();                                                                                                                                                                                                  
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            getIcon: function (sValue) {                                                                                                                                                                                                                       
                let sIcon;                                                                                                                                                                                                                                     
                let sExt = sValue.split('.').pop();                                                                                                                                                                                                            
                switch (sExt.toUpperCase()) {                                                                                                                                                                                                                  
                    case 'DOC':                                                                                                                                                                                                                                
                    case 'DOCX':                                                                                                                                                                                                                               
                        sIcon = 'sap-icon://doc-attachment';                                                                                                                                                                                                   
                        break;                                                                                                                                                                                                                                 
                    case 'XLS':                                                                                                                                                                                                                                
                    case 'XLSX':                                                                                                                                                                                                                               
                        sIcon = 'sap-icon://excel-attachment';                                                                                                                                                                                                 
                        break;                                                                                                                                                                                                                                 
                    case 'PDF':                                                                                                                                                                                                                                
                        sIcon = 'sap-icon://pdf-attachment';                                                                                                                                                                                                   
                        break;                                                                                                                                                                                                                                 
                    case 'PPT':                                                                                                                                                                                                                                
                    case 'PPTX':                                                                                                                                                                                                                               
                        sIcon = 'sap-icon://ppt-attachment';                                                                                                                                                                                                   
                        break;                                                                                                                                                                                                                                 
                    case 'TXT':                                                                                                                                                                                                                                
                        sIcon = 'sap-icon://attachment-text-file';                                                                                                                                                                                             
                        break;                                                                                                                                                                                                                                 
                    case 'JPG':                                                                                                                                                                                                                                
                    case 'JPEG':                                                                                                                                                                                                                               
                    case 'PNG':                                                                                                                                                                                                                                
                        sIcon = 'sap-icon://attachment-photo';                                                                                                                                                                                                 
                        break;                                                                                                                                                                                                                                 
                    default:                                                                                                                                                                                                                                   
                        sIcon = 'sap-icon://attachment';                                                                                                                                                                                                       
                        break;                                                                                                                                                                                                                                 
                }                                                                                                                                                                                                                                              
                return sIcon;                                                                                                                                                                                                                                  
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onAccept: function (oEvent) {                                                                                                                                                                                                                      
                sap.m.MessageBox.confirm(this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("confirmMsg"),                                                                                                                                  
                    {                                                                                                                                                                                                                                          
                        title: this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("confirmTitle"),                                                                                                                                          
                        onClose: function (sAction) {                                                                                                                                                                                                          
                            switch (sAction) {                                                                                                                                                                                                                 
                                case "OK":                                                                                                                                                                                                                     
                                    this.uploadItem();                                                                                                                                                                                                         
                                    break;                                                                                                                                                                                                                     
                                default:                                                                                                                                                                                                                       
                                    this.onClose();                                                                                                                                                                                                            
                                    break;                                                                                                                                                                                                                     
                            }                                                                                                                                                                                                                                  
                        }.bind(this)                                                                                                                                                                                                                           
                    });                                                                                                                                                                                                                                        
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            uploadItem: function (oEvent) {                                                                                                                                                                                                                    
                let oUpl = this.byId("UploadSet");                                                                                                                                                                                                             
                for (let oItem of oUpl.getIncompleteItems()) {                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                    let oXCSRFToken = new sap.ui.core.Item({                                                                                                                                                                                                   
                        key: "X-CSRF-Token",                                                                                                                                                                                                                   
                        text: this.getOwnerComponent().getModel().getSecurityToken()                                                                                                                                                                           
                    });                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                    let oSlug = new sap.ui.core.Item({                                                                                                                                                                                                         
                        key: "SLUG",                                                                                                                                                                                                                           
                        text: oItem.getProperty("fileName")                                                                                                                                                                                                    
                    });                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                    var vGuid = this.create_uuid();                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                    if (this.byId('nfe').getSelected()) {                                                                                                                                                                                                      
                        var vDoctype = '1';                                                                                                                                                                                                                    
                    } else {                                                                                                                                                                                                                                   
                        var vDoctype = '2';                                                                                                                                                                                                                    
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    let oKey = new sap.ui.core.Item({                                                                                                                                                                                                          
                        key: "Guid",                                                                                                                                                                                                                           
                        text: vGuid&nbsp;                                                                                                                                                                                                                      
                    });                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                    let oKeyDoctype = new sap.ui.core.Item({                                                                                                                                                                                                   
                        key: "Doctype",                                                                                                                                                                                                                        
                        text: vDoctype                                                                                                                                                                                                                         
                    });                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                    oUpl.addHeaderField(oXCSRFToken).addHeaderField(oSlug).addHeaderField(oKey).addHeaderField(oKeyDoctype).uploadItem(oItem);                                                                                                                 
                    oUpl.removeAllHeaderFields();                                                                                                                                                                                                              
                }                                                                                                                                                                                                                                              
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            create_uuid() {                                                                                                                                                                                                                                    
                var dt = new Date().getTime();                                                                                                                                                                                                                 
                var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {                                                                                                                                                              
                    var r = (dt + Math.random() * 16) % 16 | 0;                                                                                                                                                                                                
                    dt = Math.floor(dt / 16);                                                                                                                                                                                                                  
                    return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);                                                                                                                                                                                      
                });                                                                                                                                                                                                                                            
                return uuid;                                                                                                                                                                                                                                   
            },                                                                                                                                                                                                                                                 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                       
            onActionDownloadFile: function (oEvent) {                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Recupera primeira linha selecionada                                                                                                                                                                                                            
                =================================================================== */                                                                                                                                                                         
                let oItems = this.templateBaseExtension.getExtensionAPI().getSelectedContexts();                                                                                                                                                               
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Verifica as linhas selecionadas                                                                                                                                                                                                                
                =================================================================== */                                                                                                                                                                         
                if (!oItems.length) {                                                                                                                                                                                                                          
                    sap.m.MessageToast.show("Nenhum registro selecionado.");                                                                                                                                                                                   
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                if (oItems.length > 1) {                                                                                                                                                                                                                       
                    alert("Favor selecionar apenas um registro.");                                                                                                                                                                                             
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                var vEntitySet = "downloadPDFSet(Guid='" + oItems[0].getObject().Guid + "')/$value";                                                                                                                                                           
                var vServiceUrl = "/sap/opu/odata/sap/ZTM_RECEB_MANUAL_CTE_NFE_SRV/";                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                var oSource = vServiceUrl + vEntitySet;&nbsp;                                                                                                                                                                                                  
                var oPDFViewer = new PDFViewer();                                                                                                                                                                                                              
                this.getView().addDependent(oPDFViewer);                                                                                                                                                                                                       
                oPDFViewer.setSource(oSource);                                                                                                                                                                                                                 
                oPDFViewer.downloadPDF();                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            onActionDownloadFile2: function (oEvent) {                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Recupera primeira linha selecionada                                                                                                                                                                                                            
                =================================================================== */                                                                                                                                                                         
                let oItems = this.templateBaseExtension.getExtensionAPI().getSelectedContexts();                                                                                                                                                               
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Verifica as linhas selecionadas                                                                                                                                                                                                                
                =================================================================== */                                                                                                                                                                         
                if (!oItems.length) {                                                                                                                                                                                                                          
                    sap.m.MessageToast.show("Nenhum registro selecionado.");                                                                                                                                                                                   
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                if (oItems.length > 1) {                                                                                                                                                                                                                       
                    alert("Favor selecionar apenas um registro.");                                                                                                                                                                                             
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                var entitySet = "downloadSet(Guid='" + oItems[0].getObject().Guid + "')";                                                                                                                                                                      
                var vServiceUrl = "/sap/opu/odata/sap/ZTM_RECEB_MANUAL_CTE_NFE_SRV/";                                                                                                                                                                          
                var oModel = new sap.ui.model.odata.ODataModel(vServiceUrl, false);                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Chama Gateway para processar logs                                                                                                                                                                                                              
                =================================================================== */                                                                                                                                                                         
                var fnFunction = function () {                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                    return new Promise(function (showSuccessMessage, showErrorMessage) {                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        oModel.read(entitySet, {                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                            success: function (oData, oResponse) {                                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                                showSuccessMessage();                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                                File.save(atob(oData.Value), oData.Filename.split(".")[0], oData.Filename.split(".")[1], oData.Mimetype, "UTF-8", null, null);                                                                                                 
                                                                                                                                                                                                                                                               
                            }.bind(this),                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                            error: function (oError) {                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                                showErrorMessage();                                                                                                                                                                                                            
                                this.showLog(oError.response.body);                                                                                                                                                                                            
                                this.templateBaseExtension.getExtensionAPI().refreshTable();                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                            }.bind(this),                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        });                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                    }.bind(this))                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                }.bind(this)                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                var mParameters = {                                                                                                                                                                                                                            
                    dataloss: false                                                                                                                                                                                                                            
                };                                                                                                                                                                                                                                             
                this.extensionAPI.securedExecution(fnFunction, mParameters);                                                                                                                                                                                   
            },                                                                                                                                                                                                                                                 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                       
            showLog: function (sMessage) {                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                // Recupera texto da mensagem                                                                                                                                                                                                                  
                let aMessage = [];                                                                                                                                                                                                                             
                for (const res of sMessage.matchAll(/(?:<message>(.*?)<[/]message>)/gm)) {                                                                                                                                                                     
                    aMessage.push(res[1]);                                                                                                                                                                                                                     
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                // Recupera o tipo da mensagem                                                                                                                                                                                                                 
                let aSeverity = [];                                                                                                                                                                                                                            
                for (const res of sMessage.matchAll(/(?:<severity>(.*?)<[/]severity>)/gm)) {                                                                                                                                                                   
                    switch (res[1]) {                                                                                                                                                                                                                          
                        case "error":                                                                                                                                                                                                                          
                            aSeverity.push(sap.ui.core.MessageType.Error);                                                                                                                                                                                     
                            break;                                                                                                                                                                                                                             
                        case "info":                                                                                                                                                                                                                           
                            aSeverity.push(sap.ui.core.MessageType.Information);                                                                                                                                                                               
                            break;                                                                                                                                                                                                                             
                        case "success":                                                                                                                                                                                                                        
                            aSeverity.push(sap.ui.core.MessageType.Success);                                                                                                                                                                                   
                            break;                                                                                                                                                                                                                             
                        case "warning":                                                                                                                                                                                                                        
                            aSeverity.push(sap.ui.core.MessageType.Warning);                                                                                                                                                                                   
                            break;                                                                                                                                                                                                                             
                        default:                                                                                                                                                                                                                               
                            aSeverity.push(sap.ui.core.MessageType.None);                                                                                                                                                                                      
                            break;                                                                                                                                                                                                                             
                    }                                                                                                                                                                                                                                          
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                // Exibe mensagem                                                                                                                                                                                                                              
                for (let i = 0; i < aMessage.length; i++) {                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                    if (aMessage[i] == "Ocorreu uma exceção") {                                                                                                                                                                                                
                        continue;                                                                                                                                                                                                                              
                    }                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    //MessageManager.addMessages(new sap.ui.core.message.Message({                                                                                                                                                                             
                    sap.ui.getCore().getMessageManager().addMessages(new sap.ui.core.message.Message({                                                                                                                                                         
                        message: aMessage[i],                                                                                                                                                                                                                  
                        persistent: true, // create message as transition message                                                                                                                                                                              
                        type: aSeverity[i]                                                                                                                                                                                                                     
                    }));                                                                                                                                                                                                                                       
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
            }                                                                                                                                                                                                                                                  
        };                                                                                                                                                                                                                                                     
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               