sap.ui.define(["sap/m/PDFViewer","sap/ui/core/util/File"],function(e,t){"use strict";return{onActionDownloadFile:function(t){var a=this;let s=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();if(!s.length){alert("Nenhuma linha selecionad+
a");return}var n=false;var o=false;var i=false;for(let e=0;e<s.length;e++){if(s[e].getObject().tpdoc=="CTE"){n=true}if(s[e].getObject().tpdoc=="NFE"){o=true}if(s[e].getObject().tpdoc=="NFS"){i=true}}let r=new sap.m.RadioButtonGroup({id:"rbg3"});if(n){r.a+
ddButton(new sap.m.RadioButton({id:"xml_cte",text:"XML CTE"}));r.addButton(new sap.m.RadioButton({id:"pdf_cte",text:"PDF CTE"}))}if(o){r.addButton(new sap.m.RadioButton({id:"xml_nfe",text:"XML NFE"}));r.addButton(new sap.m.RadioButton({id:"pdf_nfe",text:+
"PDF NFE"}))}if(i){r.addButton(new sap.m.RadioButton({id:"pdf_nfs",text:"PDF NFS"}))}var l=new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Text({text:"Selecione o tipo de download desejado"}),new sap.m.Text({text:" "}),r,new sap.m.Text(+
{text:" "})]});var d=new sap.m.Dialog({type:"Message",title:"Download Informações",resizable:true,draggable:true,titleAlignment:sap.m.TitleAlignment.Center,content:l,beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:"Processar",press:fu+
nction(){if(sap.ui.getCore().byId("pdf_nfe")){if(sap.ui.getCore().byId("pdf_nfe").getSelected()){var t="1"}}if(sap.ui.getCore().byId("pdf_nfs")){if(sap.ui.getCore().byId("pdf_nfs").getSelected()){var t="1"}}if(sap.ui.getCore().byId("pdf_cte")){if(sap.ui.+
getCore().byId("pdf_cte").getSelected()){var t="2"}}if(sap.ui.getCore().byId("xml_nfe")){if(sap.ui.getCore().byId("xml_nfe").getSelected()){var t="4"}}if(sap.ui.getCore().byId("xml_cte")){if(sap.ui.getCore().byId("xml_cte").getSelected()){var t="5"}}d.cl+
ose();var a=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();var s="/sap/opu/odata/SAP/ZTM_DOWNLOAD_GESTAO_FRETE_SRV/";var n=new sap.ui.model.odata.ODataModel(s,false);for(let d=0;d<a.length;d++){var o=a[d].getObject();var i="downloadCh+
eckSet(Acckey='"+o.acckey+"',Doctype='"+t+"')";var r=async function(){await delay(5e3)};var l=function(){return new Promise(function(t,a){n.read(i,{success:function(a,n){t();if(!a.Exist){return}var o=s+"downloadSet(Acckey='"+a.Acckey+"',Doctype='"+a.Doct+
ype+"',Auto='X')/$value";var i=new e;this.getView().addDependent(i);i.setSource(o);i.downloadPDF()}.bind(this),error:function(e){a()}.bind(this)})}.bind(this))}.bind(this);this.extensionAPI.securedExecution(r,{busy:{set:true,check:false},sActionLabel:"Me+
nsagens"});this.extensionAPI.securedExecution(l,{busy:{set:true,check:false},sActionLabel:"Mensagens"})}}.bind(this)}),endButton:new sap.m.Button({text:"Cancelar",press:function(){d.close()}}),afterClose:function(){d.destroy()},contentWidth:"20%"});d.ope+
n()},showSuccessMessage:function(e){this.getView().setBusy(false)},showErrorMessage:function(e){this.getView().setBusy(false)},delay:function(e){return new Promise(t=>setTimeout(t,e))},onActionAttachment:function(e){let t=this.templateBaseExtension.getEx+
tensionAPI().getSelectedContexts();if(!t.length){sap.m.MessageToast.show("Nenhum registro selecionado.");return}for(let e=0;e<t.length;e++){if(!t[e].getObject().FreightOrder){alert("Registro sem ordem de frete.");return}if(t[e].getObject().tpdoc=="CTE"){+
if(t[e].getObject().cfop==""||t[e].getObject().cfop=="0"){alert("Campo CFOP deve estar preenchido");return}}if(!t[e].getObject().cfop_ok){alert("CFOP "+t[e].getObject().cfop+" não cadastrado na tabela de configuração");return}}var a="/sap/opu/odata/sap/Z+
UI_O2_COCKPIT_FRETE";var s=new sap.ui.model.odata.ODataModel(a,false);switch(t[0].getObject().tpdoc){case"CTE":var n="/ZI_TM_VH_ATT_SCH1";break;case"NFE":var n="/ZI_TM_VH_ATT_SCH1_NFS";break;case"NFS":var n="/ZI_TM_VH_ATT_SCH1_NFS";break}s.read(n,{succes+
s:function(e){if(e.results.length>0)this.attachmentPopUp(e.results);else alert("Nenhum tipo de anexo encontrado para esquema TM_COCKPIT")}.bind(this),error:function(e){alert("Nenhum tipo de anexo encontrado para esquema TM_COCKPIT")}.bind(this)})},attach+
mentPopUp:function(e){let t=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();var a=new sap.m.Dialog({contentWidth:"400px",resizable:true,type:"Message",escapeHandler:function(e){a.close();a.destroy()}});a.setTitle("Inserir file");var s=+
"/sap/opu/odata/SAP/ZTM_GESTAO_FRETE_ANEXO_SRV/";var n=new sap.ui.model.odata.ODataModel(s,false);var o=s+"uploadFileSet";var i=new sap.ui.unified.FileUploader({width:"100%",uploadComplete:function(e){a.close();a.destroy();this.templateBaseExtension.getE+
xtensionAPI().refreshTable();if(e.mParameters.status=="200"||e.mParameters.status=="201"){sap.m.MessageToast.show("Arquivo anexado com sucesso.")}else{let t=[];for(const a of e.mParameters.responseRaw.matchAll(/(?:<message>(.*?)<[/]message>)/gm)){t.push(+
a[1])}if(t[0]){sap.m.MessageBox.error(t[0])}else{sap.m.MessageBox.error(e.mParameters.response)}}}.bind(this)});i.setName("Simple Uploader");i.setUploadUrl(o);i.setSendXHR(true);i.setUseMultipart(false);i.setUploadOnChange(false);var r=new sap.ui.unified+
.FileUploaderParameter({name:"x-csrf-token",value:n.getSecurityToken()});i.insertHeaderParameter(r);var l=new sap.m.ComboBox({id:"idType",items:{path:"/items",template:new sap.ui.core.ListItem({key:"{AttachmentType}",text:"{AttachmentTypeText}",additiona+
lText:"{AttachmentType}"}),templateShareable:false},showSecondaryValues:true});l.setModel(new sap.ui.model.json.JSONModel({items:e}));var d=new sap.m.Input("idDescription",{width:"100%",value:"",editable:true});var u=new sap.m.Button({text:"Cancelar",typ+
e:"Reject",press:function(){a.close();a.destroy();this.getView().removeAllDependents()}.bind(this)});var c=new sap.m.Button({text:"OK",type:"Accept",press:function(){let e=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();var t=i.getFocu+
sDomRef();var a=t.files[0];var s=i.getValue();if(!s){alert("Favor selecionar um arquivo");return}var n=sap.ui.getCore().byId("idType").getSelectedKey();if(!n){alert("Favor preencher campos obrigatórios.")}if(sap.ui.getCore().byId("idDescription")){var o=+
sap.ui.getCore().byId("idDescription").getValue();if(!o){alert("Favor preencher campos obrigatórios.")}}var r=new sap.ui.unified.FileUploaderParameter({name:"Content-Type",value:a.type});i.insertHeaderParameter(r);debugger;for(let t=0;t<e.length;t++){i.i+
nsertHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"SLUG",value:e[t].getObject().acckey+";"+i.getValue()+";"+n+";"+o}));i.upload()}}.bind(this)});a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:+
"Tipo de anexo:",required:true}),l]}));a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Descrição:",required:true}),d]}));a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({tex+
t:"Conteúdo:",required:true}),i]}));a.setBeginButton(c);a.setEndButton(u);a.open()},onActionDownloadAttachment:function(e){let t=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();if(!t.length){sap.m.MessageToast.show("Nenhum registro sel+
ecionado.");return}if(t.length>1){alert("Favor selecionar apenas um registro.");return}if(!t[0].getObject().FreightOrder){alert("Registro sem ordem de frete.");return}var a=this;var s="getFileListSet";var n="/sap/opu/odata/SAP/ZTM_GESTAO_FRETE_ANEXO_SRV/+
";var o=new sap.ui.model.odata.ODataModel(n,false);let i=[];let r=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("acckey",sap.ui.model.FilterOperator.EQ,t[0].getObject().acckey)],and:true});i.push(r);var l=function(){return new Promise(functio+
n(e,t){o.read(s,{filters:i,success:function(t,a){e();this.downloadAttachment(t.results)}.bind(this),error:function(e){t();this.showLog(e.response.body)}.bind(this)})}.bind(this))}.bind(this);this.extensionAPI.securedExecution(l,{busy:{set:true,check:fals+
e},sActionLabel:"Mensagens"})},showLog:function(e){let t=[];for(const a of e.matchAll(/(?:<message>(.*?)<[/]message>)/gm)){t.push(a[1])}let a=[];for(const t of e.matchAll(/(?:<severity>(.*?)<[/]severity>)/gm)){switch(t[1]){case"error":a.push(sap.ui.core.+
MessageType.Error);break;case"info":a.push(sap.ui.core.MessageType.Information);break;case"success":a.push(sap.ui.core.MessageType.Success);break;case"warning":a.push(sap.ui.core.MessageType.Warning);break;default:a.push(sap.ui.core.MessageType.None);bre+
ak}}for(let e=0;e<t.length;e++){if(t[e]=="Ocorreu uma exceção"){continue}sap.ui.getCore().getMessageManager().addMessages(new sap.ui.core.message.Message({message:t[e],persistent:true,type:a[e]}))}},downloadAttachment:function(e){var t=this;var a=new sap+
.m.ComboBox({id:"oComboBox",items:{path:"/items",template:new sap.ui.core.ListItem({key:"{acckey};{filekey}",text:"{name}",additionalText:"{atctype}"}),templateShareable:false},showSecondaryValues:true});a.setModel(new sap.ui.model.json.JSONModel({items:+
e}));var s=new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Text({text:"Selecione o arquivo para baixar:"}),new sap.m.Text({text:" "}),a]});var n=new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:"Baixar",press:function(){var e=sap+
.ui.getCore().byId("oComboBox").getSelectedKey();if(!e){sap.m.MessageBox.warning("Favor escolher arquivo para baixar")}else{i.close();var a=e.split(";")[0];var s=e.split(";")[1];t.downloadFile(a,s)}}});var o=new sap.m.Button({text:"Cancelar",type:"Reject+
",press:function(){i.close();i.destroy();this.getView().removeAllDependents()}.bind(this)});var i=new sap.m.Dialog({type:"Message",title:"Baixar arquivo",resizable:true,draggable:true,titleAlignment:sap.m.TitleAlignment.Center,content:s,beginButton:n,end+
Button:o,afterClose:function(){i.destroy()},contentWidth:"20%"});i.open()},downloadFile:function(t,a){var s="downloadPDFSet(acckey='"+t+"',filekey='"+a+"')/$value";var n="/sap/opu/odata/SAP/ZTM_GESTAO_FRETE_ANEXO_SRV/";var o=n+s;var i=new e;this.getView(+
).addDependent(i);i.setSource(o);i.downloadPDF()},downloadFile2:function(e,a){var s="downloadFileSet(acckey='"+e+"',filekey='"+a+"')";var n="/sap/opu/odata/SAP/ZTM_GESTAO_FRETE_ANEXO_SRV/";var o=new sap.ui.model.odata.ODataModel(n,false);var i=function()+
{return new Promise(function(e,a){o.read(s,{success:function(a,s){e();t.save(atob(a.value),a.filename.split(".")[0],a.filename.split(".")[1],a.mimetype,"UTF-8",null,null)}.bind(this),error:function(e){a();this.showLog(e.response.body);this.templateBaseEx+
tension.getExtensionAPI().refreshTable()}.bind(this)})}.bind(this))}.bind(this);var r={dataloss:false};this.extensionAPI.securedExecution(i,r)}}});                                                                                                            