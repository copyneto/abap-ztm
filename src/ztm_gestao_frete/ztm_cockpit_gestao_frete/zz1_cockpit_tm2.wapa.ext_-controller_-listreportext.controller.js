sap.ui.define(["sap/m/PDFViewer","sap/ui/core/util/File","sap/m/MessagePopover","sap/m/MessageItem","sap/m/MessageToast","sap/m/Link","sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/ui/model/BindingMode","sap/ui/core/message/Message","sap+
/ui/core/library","sap/ui/core/Fragment"],function(e,t,a,s,r,o,n,i,l,u,d,p){"use strict";return{onInit:function(){},onActionDownloadFile:function(t){var a=this;let s=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();if(!s.length){alert("+
Nenhuma linha selecionada");return}var r=false;var o=false;var n=false;for(let e=0;e<s.length;e++){if(s[e].getObject().tpdoc=="CTE"){r=true}if(s[e].getObject().tpdoc=="NFE"){o=true}if(s[e].getObject().tpdoc=="NFS"){n=true}}let i=new sap.m.RadioButtonGrou+
p({id:"rbg3"});if(r){i.addButton(new sap.m.RadioButton({id:"xml_cte",text:"XML CTE"}));i.addButton(new sap.m.RadioButton({id:"pdf_cte",text:"PDF CTE"}))}if(o){i.addButton(new sap.m.RadioButton({id:"xml_nfe",text:"XML NFE"}));i.addButton(new sap.m.RadioBu+
tton({id:"pdf_nfe",text:"PDF NFE"}))}if(n){i.addButton(new sap.m.RadioButton({id:"pdf_nfs",text:"PDF NFS"}))}var l=new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Text({text:"Selecione o tipo de download desejado"}),new sap.m.Text({text+
:" "}),i,new sap.m.Text({text:" "})]});var u=new sap.m.Dialog({type:"Message",title:"Download Informações",resizable:true,draggable:true,titleAlignment:sap.m.TitleAlignment.Center,content:l,beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,t+
ext:"Processar",press:function(){if(sap.ui.getCore().byId("pdf_nfe")){if(sap.ui.getCore().byId("pdf_nfe").getSelected()){var t="1"}}if(sap.ui.getCore().byId("pdf_nfs")){if(sap.ui.getCore().byId("pdf_nfs").getSelected()){var t="1"}}if(sap.ui.getCore().byI+
d("pdf_cte")){if(sap.ui.getCore().byId("pdf_cte").getSelected()){var t="2"}}if(sap.ui.getCore().byId("xml_nfe")){if(sap.ui.getCore().byId("xml_nfe").getSelected()){var t="4"}}if(sap.ui.getCore().byId("xml_cte")){if(sap.ui.getCore().byId("xml_cte").getSel+
ected()){var t="5"}}u.close();var a=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();var s="/sap/opu/odata/SAP/ZTM_DOWNLOAD_GESTAO_FRETE_SRV/";var r=new sap.ui.model.odata.ODataModel(s,false);for(let u=0;u<a.length;u++){var o=a[u].getOb+
ject();var n="downloadCheckSet(Acckey='"+o.acckey+"',Doctype='"+t+"')";var i=async function(){await delay(5e3)};var l=function(){return new Promise(function(t,a){r.read(n,{success:function(a,r){t();if(!a.Exist){return}var o=s+"downloadSet(Acckey='"+a.Acc+
key+"',Doctype='"+a.Doctype+"',Auto='X')/$value";var n=new e;this.getView().addDependent(n);n.setSource(o);n.downloadPDF()}.bind(this),error:function(e){a()}.bind(this)})}.bind(this))}.bind(this);this.extensionAPI.securedExecution(i,{busy:{set:true,check+
:false},sActionLabel:"Mensagens"});this.extensionAPI.securedExecution(l,{busy:{set:true,check:false},sActionLabel:"Mensagens"})}}.bind(this)}),endButton:new sap.m.Button({text:"Cancelar",press:function(){u.close()}}),afterClose:function(){u.destroy()},co+
ntentWidth:"20%"});u.open()},showSuccessMessage:function(e){this.getView().setBusy(false)},showErrorMessage:function(e){this.getView().setBusy(false)},delay:function(e){return new Promise(t=>setTimeout(t,e))},onActionAttachment:function(e){sap.ui.getCore+
().getMessageManager().removeAllMessages();let t=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();if(!t.length){sap.m.MessageToast.show("Nenhum registro selecionado.");return}var a=false;var s=false;for(let e=0;e<t.length;e++){if(!t[e].+
getObject().FreightOrder){alert("Registro sem ordem de frete.");return}if(t[e].getObject().tpdoc=="CTE"){if(t[e].getObject().cfop==""||t[e].getObject().cfop=="0"){alert("Campo CFOP deve estar preenchido");return}}if(!t[e].getObject().cfop_ok){alert("CFOP+
 "+t[e].getObject().cfop+" não cadastrado na tabela de configuração");return}if(t[e].getObject().tpdoc=="CTE"){a=true}if(t[e].getObject().tpdoc=="NFE"){s=true}if(t[e].getObject().tpdoc=="NFS"){s=true}}if(a==true&&s==true){alert("Somente selecionar docume+
ntos do mesmo tipo");return}var r="/sap/opu/odata/sap/ZUI_O2_COCKPIT_FRETE";var o=new sap.ui.model.odata.ODataModel(r,false);if(a==true){var n="/ZI_TM_VH_ATT_SCH1"}else if(s==true){var n="/ZI_TM_VH_ATT_SCH1_NFS"}o.read(n,{success:function(e){if(e.results+
.length>0)this.attachmentPopUp(e.results);else alert("Nenhum tipo de anexo encontrado para esquema TM_COCKPIT")}.bind(this),error:function(e){alert("Nenhum tipo de anexo encontrado para esquema TM_COCKPIT")}.bind(this)})},attachmentPopUp:function(e){let +
t=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();var a=new sap.m.Dialog({contentWidth:"400px",resizable:true,type:"Message",escapeHandler:function(e){a.close();a.destroy()}});a.setTitle("Inserir file");var s="/sap/opu/odata/SAP/ZTM_GE+
STAO_FRETE_ANEXO_SRV/";var r=new sap.ui.model.odata.ODataModel(s,false);var o=s+"uploadFileSet";var n=new sap.ui.unified.FileUploader({width:"100%",uploadComplete:function(e){a.close();a.destroy();this.templateBaseExtension.getExtensionAPI().refreshTable+
();if(e.mParameters.status=="200"||e.mParameters.status=="201"){sap.m.MessageToast.show("Arquivo anexado com sucesso.")}else{this.showLogAttachment(e)}}.bind(this)});n.setName("Simple Uploader");n.setUploadUrl(o);n.setSendXHR(true);n.setUseMultipart(fals+
e);n.setUploadOnChange(false);var i=new sap.ui.unified.FileUploaderParameter({name:"x-csrf-token",value:r.getSecurityToken()});n.insertHeaderParameter(i);var l=new sap.m.ComboBox({id:"idType",items:{path:"/items",template:new sap.ui.core.ListItem({key:"{+
AttachmentType}",text:"{AttachmentTypeText}",additionalText:"{AttachmentType}"}),templateShareable:false},showSecondaryValues:true});l.setModel(new sap.ui.model.json.JSONModel({items:e}));var u=new sap.m.Button({text:"Cancelar",type:"Reject",press:functi+
on(){a.close();a.destroy();this.getView().removeAllDependents()}.bind(this)});var d=new sap.m.Button({text:"OK",type:"Accept",press:function(){let e=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();var t=n.getFocusDomRef();var a=t.files+
[0];var s=n.getValue();if(!s){alert("Favor selecionar um arquivo");return}var r=sap.ui.getCore().byId("idType").getSelectedKey();if(!r){alert("Favor preencher campos obrigatórios.")}var o=new sap.ui.unified.FileUploaderParameter({name:"Content-Type",valu+
e:a.type});n.insertHeaderParameter(o);var i=e.reduce(function(e,t){return t.getObject().acckey+","+e},"");n.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"SLUG",value:i+";"+n.getValue()+";"+r}));n.upload()}.bind(this)});a.addConten+
t(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Tipo de anexo:",required:true}),l]}));a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Conteúdo:",required:true}),n]}));var p=new +
sap.m.Button({text:"Teste",type:"Accept",press:function(){}.bind(this)});a.setBeginButton(d);a.setEndButton(u);a.open()},onActionDownloadAttachment:function(e){let t=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();if(!t.length){sap.m.M+
essageToast.show("Nenhum registro selecionado.");return}if(t.length>1){alert("Favor selecionar apenas um registro.");return}if(!t[0].getObject().FreightOrder){alert("Registro sem ordem de frete.");return}var a=this;var s="getFileListSet";var r="/sap/opu/+
odata/SAP/ZTM_GESTAO_FRETE_ANEXO_SRV/";var o=new sap.ui.model.odata.ODataModel(r,false);let n=[];let i=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("acckey",sap.ui.model.FilterOperator.EQ,t[0].getObject().acckey)],and:true});n.push(i);var l=+
function(){return new Promise(function(e,t){o.read(s,{filters:n,success:function(t,a){e();this.downloadAttachment(t.results)}.bind(this),error:function(e){t();this.showLog(e.response.body)}.bind(this)})}.bind(this))}.bind(this);this.extensionAPI.securedE+
xecution(l,{busy:{set:true,check:false},sActionLabel:"Mensagens"})},showLog:function(e){let t=[];for(const a of e.matchAll(/(?:<message>(.*?)<[/]message>)/gm)){t.push(a[1])}let a=[];for(const t of e.matchAll(/(?:<severity>(.*?)<[/]severity>)/gm)){switch(+
t[1]){case"error":a.push(sap.ui.core.MessageType.Error);break;case"info":a.push(sap.ui.core.MessageType.Information);break;case"success":a.push(sap.ui.core.MessageType.Success);break;case"warning":a.push(sap.ui.core.MessageType.Warning);break;default:a.p+
ush(sap.ui.core.MessageType.None);break}}for(let e=0;e<t.length;e++){if(t[e]=="Ocorreu uma exceção"){continue}sap.ui.getCore().getMessageManager().addMessages(new sap.ui.core.message.Message({message:t[e],persistent:true,type:a[e]}))}},downloadAttachment+
:function(e){var t=this;var a=new sap.m.ComboBox({id:"oComboBox",items:{path:"/items",template:new sap.ui.core.ListItem({key:"{acckey};{filekey}",text:"{name}",additionalText:"{atctype}"}),templateShareable:false},showSecondaryValues:true});a.setModel(ne+
w sap.ui.model.json.JSONModel({items:e}));var s=new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Text({text:"Selecione o arquivo para baixar:"}),new sap.m.Text({text:" "}),a]});var r=new sap.m.Button({type:sap.m.ButtonType.Emphasized,tex+
t:"Baixar",press:function(){var e=sap.ui.getCore().byId("oComboBox").getSelectedKey();if(!e){sap.m.MessageBox.warning("Favor escolher arquivo para baixar")}else{n.close();var a=e.split(";")[0];var s=e.split(";")[1];t.downloadFile(a,s)}}});var o=new sap.m+
.Button({text:"Cancelar",type:"Reject",press:function(){n.close();n.destroy();this.getView().removeAllDependents()}.bind(this)});var n=new sap.m.Dialog({type:"Message",title:"Baixar arquivo",resizable:true,draggable:true,titleAlignment:sap.m.TitleAlignme+
nt.Center,content:s,beginButton:r,endButton:o,afterClose:function(){n.destroy()},contentWidth:"20%"});n.open()},downloadFile:function(t,a){var s="downloadPDFSet(acckey='"+t+"',filekey='"+a+"')/$value";var r="/sap/opu/odata/SAP/ZTM_GESTAO_FRETE_ANEXO_SRV/+
";var o=r+s;var n=new e;this.getView().addDependent(n);n.setSource(o);n.downloadPDF()},downloadFile2:function(e,a){var s="downloadFileSet(acckey='"+e+"',filekey='"+a+"')";var r="/sap/opu/odata/SAP/ZTM_GESTAO_FRETE_ANEXO_SRV/";var o=new sap.ui.model.odata+
.ODataModel(r,false);var n=function(){return new Promise(function(e,a){o.read(s,{success:function(a,s){e();t.save(atob(a.value),a.filename.split(".")[0],a.filename.split(".")[1],a.mimetype,"UTF-8",null,null)}.bind(this),error:function(e){a();this.showLog+
(e.response.body);this.templateBaseExtension.getExtensionAPI().refreshTable()}.bind(this)})}.bind(this))}.bind(this);var i={dataloss:false};this.extensionAPI.securedExecution(n,i)},onActionGrouping:function(e){let t=this.templateBaseExtension.getExtensio+
nAPI().getSelectedContexts();if(!t.length){sap.m.MessageToast.show("Nenhum registro selecionado.");return}for(let e=0;e<t.length;e++){if(!t[e].getObject().agrupamento_ok){sap.m.MessageBox.error("Foram selecionadas linhas com status não permitido para agr+
upamento. Favor desmarcar.");return}}var a=new sap.m.Dialog({contentWidth:"400px",resizable:true,type:"Message",escapeHandler:function(e){a.close();a.destroy()}});a.setTitle("Agrupamento de Faturas");var s=t.reduce(function(e){return e+1},0);var r=new sa+
p.m.Input("idDocumentos",{width:"100%",value:"",editable:false,value:s});a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Documentos:"}),r]}));var o=new sap.m.Input("idNumFatura",{width:"100%",value:"",editable:+
true,maxLength:16});a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Número da Fatura:",required:true}),o]}));var n=t.reduce(function(e,t){if(t.getObject().vct_liq==""||t.getObject().vct_liq==null){return e}let +
a=t.getObject().vct_liq.getFullYear()+"-"+parseFloat(t.getObject().vct_liq.getMonth()+1)+"-"+t.getObject().vct_liq.getDate();if(a>e){return a}else{return e}},"");var i=new sap.m.DatePicker("idDataVenc",{width:"100%",editable:true,displayFormat:"long",val+
ueFormat:"dd-MM-yyyy",value:n});a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Data de Vencimento:",required:true}),i]}));let l=t.reduce(function(e,t){return e+parseFloat(t.getObject().vtprest)},0);var u=new s+
ap.m.Input("idValorFrete",{width:"100%",value:"",editable:false,type:"Number",value:l.toFixed(2)});a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Valor do Frete:"}),u]}));var d=new sap.m.Input("idValorDesconto+
",{width:"100%",value:"",editable:true,type:"Number",valueLiveUpdate:true,liveChange:this.onCalcularValorPagar});a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Valor do Desconto:"}),d]}));var p=new sap.m.Input+
("idValorPagar",{width:"100%",value:"",editable:false,type:"Number"});a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Valor a Pagar:"}),p]}));this.onCalcularValorPagar();var c="/sap/opu/odata/SAP/ZTM_GESTAO_FRE+
TE_ANEXO_SRV/";var m=new sap.ui.model.odata.ODataModel(c,false);var g=c+"groupingSet";var f=new sap.ui.unified.FileUploader({width:"100%",uploadComplete:function(e){a.close();a.destroy();this.templateBaseExtension.getExtensionAPI().refreshTable();if(e.mP+
arameters.status=="200"||e.mParameters.status=="201"){sap.m.MessageToast.show("Agrupamento realizado com sucesso.")}else{let t=[];for(const a of e.mParameters.responseRaw.matchAll(/(?:<message>(.*?)<[/]message>)/gm)){t.push(a[1])}if(t[0]){sap.m.MessageBo+
x.error(t[0])}else{sap.m.MessageBox.error(e.mParameters.response)}}}.bind(this)});f.setName("Simple Uploader");f.setUploadUrl(g);f.setSendXHR(true);f.setUseMultipart(false);f.setUploadOnChange(false);var h=new sap.ui.unified.FileUploaderParameter({name:"+
x-csrf-token",value:m.getSecurityToken()});f.insertHeaderParameter(h);a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Anexar autorização desconto:",required:false}),f]}));var w=new sap.m.Button({text:"Cancelar"+
,type:"Reject",press:function(){a.close();a.destroy();this.getView().removeAllDependents()}.bind(this)});var v=new sap.m.Button({text:"OK",type:"Accept",press:function(){let e=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();var t=f.get+
FocusDomRef();var s=t.files[0];var r=f.getValue();if(sap.ui.getCore().byId("idNumFatura").getValue()==""){sap.m.MessageBox.warning("Favor informar o número da fatura.");return}if(sap.ui.getCore().byId("idDataVenc").getValue()==""){sap.m.MessageBox.warnin+
g("Favor informar a data de vencimento.");return}if(parseFloat(sap.ui.getCore().byId("idValorPagar").getValue())<0){sap.m.MessageBox.warning("Valor a pagar com saldo negativo.");return}if(sap.ui.getCore().byId("idValorDesconto").getValue()!=""&&!r){sap.m+
.MessageBox.warning("Em caso de desconto, favor anexar uma autorização.");return}if(t.files.length!=0){var o=new sap.ui.unified.FileUploaderParameter({name:"Content-Type",value:s.type});f.insertHeaderParameter(o);for(let t=0;t<e.length;t++){f.insertHeade+
rParameter(new sap.ui.unified.FileUploaderParameter({name:"ACCKEY",value:e[t].getObject().acckey}))}f.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"SLUG",value:f.getValue()}));f.insertHeaderParameter(new sap.ui.unified.FileUploade+
rParameter({name:"NUMDOC",value:sap.ui.getCore().byId("idDocumentos").getValue()}));f.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"NUMFATURA",value:sap.ui.getCore().byId("idNumFatura").getValue()}));f.insertHeaderParameter(new sa+
p.ui.unified.FileUploaderParameter({name:"DATAVENC",value:sap.ui.getCore().byId("idDataVenc").getValue()}));f.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"VALORFRETE",value:sap.ui.getCore().byId("idValorFrete").getValue()}));f.in+
sertHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"VALORDESCONTO",value:sap.ui.getCore().byId("idValorDesconto").getValue()}));f.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"VALORPAGAR",value:sap.ui.getCore().byI+
d("idValorPagar").getValue()}));f.upload()}else{var n=this;var i="groupingCreateSet";var l="/sap/opu/odata/SAP/ZTM_GESTAO_FRETE_ANEXO_SRV/";var u=new sap.ui.model.odata.ODataModel(l,false);let t=[];for(let a=0;a<e.length;a++){var d=new sap.ui.model.Filte+
r("acckey",sap.ui.model.FilterOperator.EQ,e[a].getObject().acckey);t.push(d)}var d=new sap.ui.model.Filter("numdoc",sap.ui.model.FilterOperator.EQ,sap.ui.getCore().byId("idDocumentos").getValue());t.push(d);var d=new sap.ui.model.Filter("numfatura",sap.u+
i.model.FilterOperator.EQ,sap.ui.getCore().byId("idNumFatura").getValue());t.push(d);var d=new sap.ui.model.Filter("datavenc",sap.ui.model.FilterOperator.EQ,sap.ui.getCore().byId("idDataVenc").getValue());t.push(d);var d=new sap.ui.model.Filter("valorfre+
te",sap.ui.model.FilterOperator.EQ,sap.ui.getCore().byId("idValorFrete").getValue());t.push(d);var d=new sap.ui.model.Filter("valordesconto",sap.ui.model.FilterOperator.EQ,sap.ui.getCore().byId("idValorDesconto").getValue());t.push(d);var d=new sap.ui.mo+
del.Filter("valorpagar",sap.ui.model.FilterOperator.EQ,sap.ui.getCore().byId("idValorPagar").getValue());t.push(d);a.close();a.destroy();var n=this;var p=function(){return new Promise(function(e,a){u.read(i,{filters:t,success:function(t,a){e();n.template+
BaseExtension.getExtensionAPI().refreshTable()}.bind(this),error:function(e){a();n.templateBaseExtension.getExtensionAPI().refreshTable();this.showLog(e.response.body)}.bind(this)})}.bind(this))}.bind(this);this.extensionAPI.securedExecution(p,{busy:{set+
:true,check:false},sActionLabel:"Mensagens"})}}.bind(this)});a.setBeginButton(v);a.setEndButton(w);a.open()},onCalcularValorPagar:function(e){var t=parseFloat(sap.ui.getCore().byId("idValorFrete").getValue());if(isNaN(t)){t=0}var a=parseFloat(sap.ui.getC+
ore().byId("idValorDesconto").getValue());if(isNaN(a)){a=0}let s=(t-a).toFixed(2);sap.ui.getCore().byId("idValorPagar").setValue(s)},showLogAttachment:function(e){let t=[];for(const a of e.mParameters.responseRaw.matchAll(/(?:<message>(.*?)<[/]message>)/+
gm)){t.push(a[1])}let a=[];for(const t of e.mParameters.responseRaw.matchAll(/(?:<severity>(.*?)<[/]severity>)/gm)){switch(t[1]){case"error":a.push(sap.ui.core.MessageType.Error);break;case"info":a.push(sap.ui.core.MessageType.Information);break;case"suc+
cess":a.push(sap.ui.core.MessageType.Success);break;case"warning":a.push(sap.ui.core.MessageType.Warning);break;default:a.push(sap.ui.core.MessageType.None);break}}for(let e=0;e<t.length;e++){if(t[e]=="Ocorreu uma exceção"){continue}switch(a[e]){case"Err+
or":sap.m.MessageBox.error(t[e]);break;case"Info":sap.m.MessageBox.information(t[e]);break;case"Success":sap.m.MessageBox.success(t[e]);break;case"Warning":sap.m.MessageBox.warning(t[e]);break;default:sap.m.MessageBox.info(t[e]);break}}}}});              