sap.ui.define(["sap/m/PDFViewer","sap/ui/core/util/File"],function(e,t){"use strict";return{onActionDownloadFile:function(t){var a=this;let r=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();if(!r.length){alert("Nenhuma linha selecionad+
a");return}var s=false;var o=false;var n=false;for(let e=0;e<r.length;e++){if(r[e].getObject().tpdoc=="CTE"){s=true}if(r[e].getObject().tpdoc=="NFE"){o=true}if(r[e].getObject().tpdoc=="NFS"){n=true}}let i=new sap.m.RadioButtonGroup({id:"rbg3"});if(s){i.a+
ddButton(new sap.m.RadioButton({id:"xml_cte",text:"XML CTE"}));i.addButton(new sap.m.RadioButton({id:"pdf_cte",text:"PDF CTE"}))}if(o){i.addButton(new sap.m.RadioButton({id:"xml_nfe",text:"XML NFE"}));i.addButton(new sap.m.RadioButton({id:"pdf_nfe",text:+
"PDF NFE"}))}if(n){i.addButton(new sap.m.RadioButton({id:"pdf_nfs",text:"PDF NFS"}))}var l=new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Text({text:"Selecione o tipo de download desejado"}),new sap.m.Text({text:" "}),i,new sap.m.Text(+
{text:" "})]});var u=new sap.m.Dialog({type:"Message",title:"Download Informações",resizable:true,draggable:true,titleAlignment:sap.m.TitleAlignment.Center,content:l,beginButton:new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:"Processar",press:fu+
nction(){if(sap.ui.getCore().byId("pdf_nfe")){if(sap.ui.getCore().byId("pdf_nfe").getSelected()){var t="1"}}if(sap.ui.getCore().byId("pdf_nfs")){if(sap.ui.getCore().byId("pdf_nfs").getSelected()){var t="1"}}if(sap.ui.getCore().byId("pdf_cte")){if(sap.ui.+
getCore().byId("pdf_cte").getSelected()){var t="2"}}if(sap.ui.getCore().byId("xml_nfe")){if(sap.ui.getCore().byId("xml_nfe").getSelected()){var t="4"}}if(sap.ui.getCore().byId("xml_cte")){if(sap.ui.getCore().byId("xml_cte").getSelected()){var t="5"}}u.cl+
ose();var a=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();var r="/sap/opu/odata/SAP/ZTM_DOWNLOAD_GESTAO_FRETE_SRV/";var s=new sap.ui.model.odata.ODataModel(r,false);for(let u=0;u<a.length;u++){var o=a[u].getObject();var n="downloadCh+
eckSet(Acckey='"+o.acckey+"',Doctype='"+t+"')";var i=async function(){await delay(5e3)};var l=function(){return new Promise(function(t,a){s.read(n,{success:function(a,s){t();if(!a.Exist){return}var o=r+"downloadSet(Acckey='"+a.Acckey+"',Doctype='"+a.Doct+
ype+"',Auto='X')/$value";var n=new e;this.getView().addDependent(n);n.setSource(o);n.downloadPDF()}.bind(this),error:function(e){a()}.bind(this)})}.bind(this))}.bind(this);this.extensionAPI.securedExecution(i,{busy:{set:true,check:false},sActionLabel:"Me+
nsagens"});this.extensionAPI.securedExecution(l,{busy:{set:true,check:false},sActionLabel:"Mensagens"})}}.bind(this)}),endButton:new sap.m.Button({text:"Cancelar",press:function(){u.close()}}),afterClose:function(){u.destroy()},contentWidth:"20%"});u.ope+
n()},showSuccessMessage:function(e){this.getView().setBusy(false)},showErrorMessage:function(e){this.getView().setBusy(false)},delay:function(e){return new Promise(t=>setTimeout(t,e))},onActionAttachment:function(e){let t=this.templateBaseExtension.getEx+
tensionAPI().getSelectedContexts();if(!t.length){sap.m.MessageToast.show("Nenhum registro selecionado.");return}var a=false;var r=false;for(let e=0;e<t.length;e++){if(!t[e].getObject().FreightOrder){alert("Registro sem ordem de frete.");return}if(t[e].ge+
tObject().tpdoc=="CTE"){if(t[e].getObject().cfop==""||t[e].getObject().cfop=="0"){alert("Campo CFOP deve estar preenchido");return}}if(!t[e].getObject().cfop_ok){alert("CFOP "+t[e].getObject().cfop+" não cadastrado na tabela de configuração");return}if(t+
[e].getObject().tpdoc=="CTE"){a=true}if(t[e].getObject().tpdoc=="NFE"){r=true}if(t[e].getObject().tpdoc=="NFS"){r=true}}if(a==true&&r==true){alert("Somente selecionar documentos do mesmo tipo");return}var s="/sap/opu/odata/sap/ZUI_O2_COCKPIT_FRETE";var o+
=new sap.ui.model.odata.ODataModel(s,false);if(a==true){var n="/ZI_TM_VH_ATT_SCH1"}else if(r==true){var n="/ZI_TM_VH_ATT_SCH1_NFS"}o.read(n,{success:function(e){if(e.results.length>0)this.attachmentPopUp(e.results);else alert("Nenhum tipo de anexo encont+
rado para esquema TM_COCKPIT")}.bind(this),error:function(e){alert("Nenhum tipo de anexo encontrado para esquema TM_COCKPIT")}.bind(this)})},attachmentPopUp:function(e){let t=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();var a=new sa+
p.m.Dialog({contentWidth:"400px",resizable:true,type:"Message",escapeHandler:function(e){a.close();a.destroy()}});a.setTitle("Inserir file");var r="/sap/opu/odata/SAP/ZTM_GESTAO_FRETE_ANEXO_SRV/";var s=new sap.ui.model.odata.ODataModel(r,false);var o=r+"+
uploadFileSet";var n=new sap.ui.unified.FileUploader({width:"100%",uploadComplete:function(e){a.close();a.destroy();this.templateBaseExtension.getExtensionAPI().refreshTable();if(e.mParameters.status=="200"||e.mParameters.status=="201"){sap.m.MessageToas+
t.show("Arquivo anexado com sucesso.")}else{let t=[];for(const a of e.mParameters.responseRaw.matchAll(/(?:<message>(.*?)<[/]message>)/gm)){t.push(a[1])}if(t[0]){sap.m.MessageBox.error(t[0])}else{sap.m.MessageBox.error(e.mParameters.response)}}}.bind(thi+
s)});n.setName("Simple Uploader");n.setUploadUrl(o);n.setSendXHR(true);n.setUseMultipart(false);n.setUploadOnChange(false);var i=new sap.ui.unified.FileUploaderParameter({name:"x-csrf-token",value:s.getSecurityToken()});n.insertHeaderParameter(i);var l=n+
ew sap.m.ComboBox({id:"idType",items:{path:"/items",template:new sap.ui.core.ListItem({key:"{AttachmentType}",text:"{AttachmentTypeText}",additionalText:"{AttachmentType}"}),templateShareable:false},showSecondaryValues:true});l.setModel(new sap.ui.model.+
json.JSONModel({items:e}));var u=new sap.m.Input("idDescription",{width:"100%",value:"",editable:false,value:t[0].getObject().acckey});var d=new sap.m.Button({text:"Cancelar",type:"Reject",press:function(){a.close();a.destroy();this.getView().removeAllDe+
pendents()}.bind(this)});var p=new sap.m.Button({text:"OK",type:"Accept",press:function(){let e=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();var t=n.getFocusDomRef();var a=t.files[0];var r=n.getValue();if(!r){alert("Favor selecionar+
 um arquivo");return}var s=sap.ui.getCore().byId("idType").getSelectedKey();if(!s){alert("Favor preencher campos obrigatórios.")}if(sap.ui.getCore().byId("idDescription")){var o=sap.ui.getCore().byId("idDescription").getValue();if(!o){alert("Favor preenc+
her campos obrigatórios.")}}var i=new sap.ui.unified.FileUploaderParameter({name:"Content-Type",value:a.type});n.insertHeaderParameter(i);debugger;for(let t=0;t<e.length;t++){n.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"SLUG",v+
alue:e[t].getObject().acckey+";"+n.getValue()+";"+s+";"+e[t].getObject().acckey}));n.upload()}}.bind(this)});a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Tipo de anexo:",required:true}),l]}));a.addContent(ne+
w sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Descrição:",required:true}),u]}));a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Conteúdo:",required:true}),n]}));a.setBeginButton(p+
);a.setEndButton(d);a.open()},onActionDownloadAttachment:function(e){let t=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();if(!t.length){sap.m.MessageToast.show("Nenhum registro selecionado.");return}if(t.length>1){alert("Favor selecio+
nar apenas um registro.");return}if(!t[0].getObject().FreightOrder){alert("Registro sem ordem de frete.");return}var a=this;var r="getFileListSet";var s="/sap/opu/odata/SAP/ZTM_GESTAO_FRETE_ANEXO_SRV/";var o=new sap.ui.model.odata.ODataModel(s,false);let+
 n=[];let i=new sap.ui.model.Filter({filters:[new sap.ui.model.Filter("acckey",sap.ui.model.FilterOperator.EQ,t[0].getObject().acckey)],and:true});n.push(i);var l=function(){return new Promise(function(e,t){o.read(r,{filters:n,success:function(t,a){e();t+
his.downloadAttachment(t.results)}.bind(this),error:function(e){t();this.showLog(e.response.body)}.bind(this)})}.bind(this))}.bind(this);this.extensionAPI.securedExecution(l,{busy:{set:true,check:false},sActionLabel:"Mensagens"})},showLog:function(e){let+
 t=[];for(const a of e.matchAll(/(?:<message>(.*?)<[/]message>)/gm)){t.push(a[1])}let a=[];for(const t of e.matchAll(/(?:<severity>(.*?)<[/]severity>)/gm)){switch(t[1]){case"error":a.push(sap.ui.core.MessageType.Error);break;case"info":a.push(sap.ui.core+
.MessageType.Information);break;case"success":a.push(sap.ui.core.MessageType.Success);break;case"warning":a.push(sap.ui.core.MessageType.Warning);break;default:a.push(sap.ui.core.MessageType.None);break}}for(let e=0;e<t.length;e++){if(t[e]=="Ocorreu uma +
exceção"){continue}sap.ui.getCore().getMessageManager().addMessages(new sap.ui.core.message.Message({message:t[e],persistent:true,type:a[e]}))}},downloadAttachment:function(e){var t=this;var a=new sap.m.ComboBox({id:"oComboBox",items:{path:"/items",templ+
ate:new sap.ui.core.ListItem({key:"{acckey};{filekey}",text:"{name}",additionalText:"{atctype}"}),templateShareable:false},showSecondaryValues:true});a.setModel(new sap.ui.model.json.JSONModel({items:e}));var r=new sap.ui.layout.VerticalLayout({width:"10+
0%",content:[new sap.m.Text({text:"Selecione o arquivo para baixar:"}),new sap.m.Text({text:" "}),a]});var s=new sap.m.Button({type:sap.m.ButtonType.Emphasized,text:"Baixar",press:function(){var e=sap.ui.getCore().byId("oComboBox").getSelectedKey();if(!e+
){sap.m.MessageBox.warning("Favor escolher arquivo para baixar")}else{n.close();var a=e.split(";")[0];var r=e.split(";")[1];t.downloadFile(a,r)}}});var o=new sap.m.Button({text:"Cancelar",type:"Reject",press:function(){n.close();n.destroy();this.getView(+
).removeAllDependents()}.bind(this)});var n=new sap.m.Dialog({type:"Message",title:"Baixar arquivo",resizable:true,draggable:true,titleAlignment:sap.m.TitleAlignment.Center,content:r,beginButton:s,endButton:o,afterClose:function(){n.destroy()},contentWid+
th:"20%"});n.open()},downloadFile:function(t,a){var r="downloadPDFSet(acckey='"+t+"',filekey='"+a+"')/$value";var s="/sap/opu/odata/SAP/ZTM_GESTAO_FRETE_ANEXO_SRV/";var o=s+r;var n=new e;this.getView().addDependent(n);n.setSource(o);n.downloadPDF()},down+
loadFile2:function(e,a){var r="downloadFileSet(acckey='"+e+"',filekey='"+a+"')";var s="/sap/opu/odata/SAP/ZTM_GESTAO_FRETE_ANEXO_SRV/";var o=new sap.ui.model.odata.ODataModel(s,false);var n=function(){return new Promise(function(e,a){o.read(r,{success:fu+
nction(a,r){e();t.save(atob(a.value),a.filename.split(".")[0],a.filename.split(".")[1],a.mimetype,"UTF-8",null,null)}.bind(this),error:function(e){a();this.showLog(e.response.body);this.templateBaseExtension.getExtensionAPI().refreshTable()}.bind(this)})+
}.bind(this))}.bind(this);var i={dataloss:false};this.extensionAPI.securedExecution(n,i)},onActionGrouping:function(e){let t=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();if(!t.length){sap.m.MessageToast.show("Nenhum registro selecio+
nado.");return}for(let e=0;e<t.length;e++){if(!t[e].getObject().agrupamento_ok){sap.m.MessageBox.error("Foram selecionadas linhas com status não permitido para agrupamento. Favor desmarcar.");return}}var a=new sap.m.Dialog({contentWidth:"400px",resizable+
:true,type:"Message",escapeHandler:function(e){a.close();a.destroy()}});a.setTitle("Agrupamento de Faturas");var r=t.reduce(function(e){return e+1},0);var s=new sap.m.Input("idDocumentos",{width:"100%",value:"",editable:false,value:r});a.addContent(new s+
ap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Documentos:"}),s]}));var o=new sap.m.Input("idNumFatura",{width:"100%",value:"",editable:true,maxLength:16});a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[ne+
w sap.m.Label({text:"Número da Fatura:",required:true}),o]}));var n=t.reduce(function(e,t){if(t.getObject().vct_liq==""||t.getObject().vct_liq==null){return e}let a=t.getObject().vct_liq.getFullYear()+"-"+parseFloat(t.getObject().vct_liq.getMonth()+1)+"-+
"+t.getObject().vct_liq.getDate();if(a>e){return a}else{return e}},"");var i=new sap.m.DatePicker("idDataVenc",{width:"100%",editable:true,displayFormat:"long",valueFormat:"dd-MM-yyyy",value:n});a.addContent(new sap.ui.layout.VerticalLayout({width:"100%"+
,content:[new sap.m.Label({text:"Data de Vencimento:",required:true}),i]}));let l=t.reduce(function(e,t){return e+parseFloat(t.getObject().vtprest)},0);var u=new sap.m.Input("idValorFrete",{width:"100%",value:"",editable:false,type:"Number",value:l.toFix+
ed(2)});a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Valor do Frete:"}),u]}));var d=new sap.m.Input("idValorDesconto",{width:"100%",value:"",editable:true,type:"Number",valueLiveUpdate:true,liveChange:this.o+
nCalcularValorPagar});a.addContent(new sap.ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Valor do Desconto:"}),d]}));var p=new sap.m.Input("idValorPagar",{width:"100%",value:"",editable:false,type:"Number"});a.addContent(new sap.+
ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Valor a Pagar:"}),p]}));this.onCalcularValorPagar();var c="/sap/opu/odata/SAP/ZTM_GESTAO_FRETE_ANEXO_SRV/";var m=new sap.ui.model.odata.ODataModel(c,false);var g=c+"groupingSet";var f+
=new sap.ui.unified.FileUploader({width:"100%",uploadComplete:function(e){a.close();a.destroy();this.templateBaseExtension.getExtensionAPI().refreshTable();if(e.mParameters.status=="200"||e.mParameters.status=="201"){sap.m.MessageToast.show("Agrupamento +
realizado com sucesso.")}else{let t=[];for(const a of e.mParameters.responseRaw.matchAll(/(?:<message>(.*?)<[/]message>)/gm)){t.push(a[1])}if(t[0]){sap.m.MessageBox.error(t[0])}else{sap.m.MessageBox.error(e.mParameters.response)}}}.bind(this)});f.setName+
("Simple Uploader");f.setUploadUrl(g);f.setSendXHR(true);f.setUseMultipart(false);f.setUploadOnChange(false);var h=new sap.ui.unified.FileUploaderParameter({name:"x-csrf-token",value:m.getSecurityToken()});f.insertHeaderParameter(h);a.addContent(new sap.+
ui.layout.VerticalLayout({width:"100%",content:[new sap.m.Label({text:"Anexar autorização desconto:",required:false}),f]}));var w=new sap.m.Button({text:"Cancelar",type:"Reject",press:function(){a.close();a.destroy();this.getView().removeAllDependents()}+
.bind(this)});var v=new sap.m.Button({text:"OK",type:"Accept",press:function(){let e=this.templateBaseExtension.getExtensionAPI().getSelectedContexts();var t=f.getFocusDomRef();var r=t.files[0];var s=f.getValue();if(sap.ui.getCore().byId("idNumFatura").g+
etValue()==""){sap.m.MessageBox.warning("Favor informar o número da fatura.");return}if(sap.ui.getCore().byId("idDataVenc").getValue()==""){sap.m.MessageBox.warning("Favor informar a data de vencimento.");return}if(parseFloat(sap.ui.getCore().byId("idVal+
orPagar").getValue())<0){sap.m.MessageBox.warning("Valor a pagar com saldo negativo.");return}if(sap.ui.getCore().byId("idValorDesconto").getValue()!=""&&!s){sap.m.MessageBox.warning("Em caso de desconto, favor anexar uma autorização.");return}if(t.files+
.length!=0){var o=new sap.ui.unified.FileUploaderParameter({name:"Content-Type",value:r.type});f.insertHeaderParameter(o);for(let t=0;t<e.length;t++){f.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"ACCKEY",value:e[t].getObject().a+
cckey}))}f.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"SLUG",value:f.getValue()}));f.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"NUMDOC",value:sap.ui.getCore().byId("idDocumentos").getValue()}));f.inser+
tHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"NUMFATURA",value:sap.ui.getCore().byId("idNumFatura").getValue()}));f.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"DATAVENC",value:sap.ui.getCore().byId("idDataVenc+
").getValue()}));f.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"VALORFRETE",value:sap.ui.getCore().byId("idValorFrete").getValue()}));f.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"VALORDESCONTO",value:sa+
p.ui.getCore().byId("idValorDesconto").getValue()}));f.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({name:"VALORPAGAR",value:sap.ui.getCore().byId("idValorPagar").getValue()}));f.upload()}else{var n=this;var i="groupingCreateSet";var l=+
"/sap/opu/odata/SAP/ZTM_GESTAO_FRETE_ANEXO_SRV/";var u=new sap.ui.model.odata.ODataModel(l,false);let t=[];for(let a=0;a<e.length;a++){var d=new sap.ui.model.Filter("acckey",sap.ui.model.FilterOperator.EQ,e[a].getObject().acckey);t.push(d)}var d=new sap.+
ui.model.Filter("numdoc",sap.ui.model.FilterOperator.EQ,sap.ui.getCore().byId("idDocumentos").getValue());t.push(d);var d=new sap.ui.model.Filter("numfatura",sap.ui.model.FilterOperator.EQ,sap.ui.getCore().byId("idNumFatura").getValue());t.push(d);var d=+
new sap.ui.model.Filter("datavenc",sap.ui.model.FilterOperator.EQ,sap.ui.getCore().byId("idDataVenc").getValue());t.push(d);var d=new sap.ui.model.Filter("valorfrete",sap.ui.model.FilterOperator.EQ,sap.ui.getCore().byId("idValorFrete").getValue());t.push+
(d);var d=new sap.ui.model.Filter("valordesconto",sap.ui.model.FilterOperator.EQ,sap.ui.getCore().byId("idValorDesconto").getValue());t.push(d);var d=new sap.ui.model.Filter("valorpagar",sap.ui.model.FilterOperator.EQ,sap.ui.getCore().byId("idValorPagar"+
).getValue());t.push(d);a.close();a.destroy();var n=this;var p=function(){return new Promise(function(e,a){u.read(i,{filters:t,success:function(t,a){e();n.templateBaseExtension.getExtensionAPI().refreshTable()}.bind(this),error:function(e){a();n.template+
BaseExtension.getExtensionAPI().refreshTable();this.showLog(e.response.body)}.bind(this)})}.bind(this))}.bind(this);this.extensionAPI.securedExecution(p,{busy:{set:true,check:false},sActionLabel:"Mensagens"})}}.bind(this)});a.setBeginButton(v);a.setEndBu+
tton(w);a.open()},onCalcularValorPagar:function(e){var t=parseFloat(sap.ui.getCore().byId("idValorFrete").getValue());if(isNaN(t)){t=0}var a=parseFloat(sap.ui.getCore().byId("idValorDesconto").getValue());if(isNaN(a)){a=0}let r=(t-a).toFixed(2);sap.ui.ge+
tCore().byId("idValorPagar").setValue(r)}}});                                                                                                                                                                                                                  